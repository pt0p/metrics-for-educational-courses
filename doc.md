# Метрики задач

## Доля решивших
Доля пользователей, решивших задачу, среди совершивших хотя бы одну попытку.

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

Не учитываются прогрессы с 0 попыток.

### Реализация
Название класса: `SolvedPercentage`

Критическое значение метрики: `< 0.88`

Необходимые данные: `user_element_progress`

Параметры: нет.

## Среднее количество попыток
Среднее количество попыток, затрачиваемое учеником на задачу.

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

Не учитываются прогрессы с 0 попыток.

### Реализация
Название класса: `MeanTriesCount`

Критическое значение метрики: `> 4`

Необходимые данные: `user_element_progress`

Параметры:

- `outlier` (`float`) - если это значение превышено для некоторого прогресса ученика по элементу, то этот прогресс не учитывается при расчете среднего. Значение по умолчанию - 65.

Применяется фильтрация. Оставшиеся записи группируются по id задачи, количество попыток усредняется для каждой задачи.

## Доля угадываний
Доля пользователей, совершивших хотя бы 5 попыток с разницей менее 10 секунд между соседними попытками, среди пытавшихся решить задачу.

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

Не учитываются прогрессы с 0 попыток.

### Реализация
Название класса: `GuessedPercentage`

Критическое значение метрики: `> 0.2`

Необходимые данные: `user_element_progress, soluton_log`

Параметры: нет.

Применяется фильтрация. Расчитывается время между соседними попытками для каждого прогресса (прогресс определяется парой (ученик, задача)). Если нашлось 5 попыток с разницами менее 10 секунд между соседними, ученик угадывал задачу. иначе - нет. В соответствии с этим прогрессу сопоставляется флаг `guessed`. Для каждой задачи подсчитывается количество угадывавших учеников `guessed_count`.

Для каждой задачи считается количество учеников, совершивших хотя бы одну попытку `tried_count`.

Доля угадываний = `guessed_count` / `tried_count`

## Доля решивших за много попыток
Доля пользователей, решивших задачу не менее чем с N-й попытки. N - параметр, по умолчанию равен 7.

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

### Реализация
Название класса: `NTries`

Критическое значение метрики: `> 0.1`

Необходимые данные: `user_element_progress`

Параметры: `N` - из определения метрики.

Замечание: при изменении `N` логично подобрать новое критическое значение.

## Среднее время дорешки
Среднее суммарное время (в минутах), потраченное пользователем на данную задачу. Время на первую попытку не учитывается. Интервалы между попытками длиннее 40 минут не учитываются.

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

Не учитываются интервалы между попытками длиннее 40 минут.

Рассматриваются только прогрессы, в которых ученик решил задачу.

### Реализация
Название класса: `TaskTime`

Критическое значение метрики: `> 7.5`

Необходимые данные: `user_element_progress, course_element, solution_log`

Параметры: `metric` - среднее или медиану (`mean`, `median`) использовать для аггрегации времени затраченного на одну задачу многими учениками. По умолчанию - среднее.

Для каждой задачи для каждого пользователя считаются временные интервалы между попытками, интервалы короче 40 минут суммируются. Для каждой задачи берется среднее по полученным значениям.


## Доля нерешивших среди продолжающих

Доля пользователей, нерешивших задачу, но решивших предыдущую, среди тех, кому открыта задача.

Определена только для задач, идущих в модуле после других задач (а не видео/текста).

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

### Реализация
Название класса: `LostPercentage`

Критическое значение метрики: `> 0.15`

Необходимые данные: `user_element_progress, course_element`

Параметры: нет.

Применяется фильтрация данных. Прогрессы группируются по пользователю и модулю. Для каждого прогресса по задаче в модуле (которой не предшествует видео/текст) добаляется флаг `prev_is_solved` (предыдущая задача решена).

Для каждой задачи считается количество учеников, решивших предыдущую задачу `prev_is_solved_count`.

Для каждой задачи считается количество `user_id` в таблице `user_element_progress` - это количество учеников, которым открыта данная задача `user_count`.

Доля нерешивших среди продолжающих = `prev_is_solved_count` / `user_count`


## Доля пропусков
Доля учеников, пропустивших данную задачу, среди всех учеников, которым она открыта.

Задача считается пропущенной в двух случаях:
- задача не решена данным учеником, но он решил какую-либо задачу из того же модуля, которая идет в нем позже по порядку.
- задача решена данным учеником, но он решил какую-либо задачу из того же модуля, которая идет в нем позже по порядку, раньше, чем текущую.

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

### Реализация
Название класса: `SkipsPercentage`

Критическое значение метрики: `> 0.2`

Необходимые данные: `user_element_progress, course_element`

Параметры: нет.

Применяется фильтрация данных. Далее добавляется колонка `skipped` со значениями True/False (задача пропущена/не пропущена учеником). Для каждой задачи по колонке `skipped` расчитывается количество пропусков `skips_count`.

Для каждой задачи считается количество `user_id` в таблице `user_element_progress` - это количество учеников, которым открыта данная задача `user_count`.

Доля пропусков = `skips_count` / `user_count`

# Метрики модулей

## Число учеников
Количество учеников, совершивших хотя бы одну попытку в модуле.

### Фильтрация данных
Не учитываются прогрессы по модулям с `achieve_reason == autograde`.

Не учитываются прогрессы по модулям, в которых не было совершено ни одной попытки.

### Реализация
Название класса: `ModuleUserCount`

Критическое значение метрики: нет

Необходимые данные: `user_element_progress, user_module_progress`

Параметры: нет.

## Доля зачетов
Доля учеников, получивших зачет за модуль, среди совершивших хотя бы одну попытку в модуле.

### Фильтрация данных
Не учитываются прогрессы по модулям с `achieve_reason == autograde`.

Не учитываются прогрессы по модулям, в которых не было совершено ни одной попытки.

### Реализация
Название класса: `ModuleAchievedPercentage`

Критическое значение метрики: `< 0.5`

Необходимые данные: `user_element_progress, user_module_progress`

Параметры: нет.

## Среднее время
Среднее время в минутах, затраченное пользователем на модуль. Считается как сумма временных интервалов между последовательными действиями пользователя в модуле. Интервалы длиннее 40 минут не учитываются.

### Фильтрация данных
Не учитываются прогрессы, для которых нет времени в `solution_log`.

### Реализация
Название класса: `ModuleTime`

Критическое значение метрики: `> 80`

Необходимые данные: `user_element_progress, user_module_progress, solution_log`

Параметры: `max_timedelta_min` - максимальная длина интервала между попытками, который не выкидывается из суммирования, в минутах (по умолчанию 40).

Считается время на модуль для каждого пользователя, затем оно усредняется. Чтобы посчитать для одного пользователя, берутся все его действия в модуле по задачам (из `solution_log`) и по текстам/видео (из `user_element_progress`). Между ними считаются временные интервалы, и все интервалы, не превосходящие `max_timedelta_min`, суммируются.

## Среднее число попыток
Среднее число попыток, суммарно совершаемых пользователем на задачи данного модуля.

### Фильтрация данных
Не учитываются перенесенные прогрессы (`achieve_reason == 'trasferred'`). 

### Реализация
Название класса: `ModuleMeanTries`

Критическое значение метрики: `> 4`

Необходимые данные: `user_element_progress`

Параметры: нет.

# Структура отчета

## Общая информация о курсе
### Фактоиды курса
### Карта курса
Вершины в карте - модули курса. При нажатии на вершину пользователь перемещается к анализу соответствующего модуля.

Вершины карты раскрашиваются в соответствии со сложностью модулей по метрике, выбранной в dropdown меню в левом верхнем углу карты. Чем ярче красный - тем сложнее модуль.

### Таблица с метриками модулей
В таблице представлены все метрики всех модулей данного курса. Ячейки таблицы раскрашены по сложности (аналогично вершинам карты курса). При наведении на название метрики пользователь получает ее краткое описание.

### Список сложных задач
Текстовый блок с номерами задач, сложных по какому-либо критерию. Критерий также указывается в списке.

### Выгрузка ответов учеников
Кнопка для выгрузки веера ответов по любой задаче курса.

## Информация о модулях
Далее следует подробный анализ каждого модуля.
### Краткие сведения о модуле
- Название модуля
- Мини-карта, на которой отражено место модуля в курсе. Она кликабельна, и при нажатии на модуль пользователь переносится к его анализу
- Фактоиды с метриками модуля

### Интересные факты о задачах
Это блок текстовых подсказок с задачами, у которых экстремальные значения метрик.

На нескольких различных курсах предварительно расчитаны 95-й, 96-й,.., 99-й перцентиль для каждой метрике. Если метрика для данной задачи превышает эти значения, то она попадает в топ 5%, 4%,.., 1% сложных задач по метрике соответственно.
### Таблица с метриками задач
Все метрики задач модуля. Серая ячейка - значение метрики не определено для задачи. Сиреневый столбец - элемент является видео или текстом, а не задачей. Остальные ячейки раскрашены по сложности (аналогично вершинам карты курса).

При наведении на название метрики пользователь получает ее краткое описание.

### Столбчатая диаграмма
Для данного модуля можно построить столбчатую диаграмму, показывающую значение метрики для всех задач модуля (при этом столбцы раскрашены аналогично ячейкам таблицы метрик задач). Эту диаграмму можно построить по любой метрике задачи - метрика выбирается в dropdown меню в левом верхнем углу диаграммы.